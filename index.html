<!DOCTYPE html>
<html>
  <head>
    <title>ðŸŽ¤ Karaoke requests</title>
    <link href="style.css" type="text/css" rel="stylesheet">
  </head>
  <body ng-app="karaoke" ng-controller="index as index">
    <header>
      <input type="text" ng-model="query" placeholder="Search by artist or title" autofocus />
    </header>
    <main class="ng-cloak">
      <h2 ng-hide="index.songs">ðŸŽµ Loading</h2>
      <h5>
        <label>
          <input type="checkbox" ng-model="showQueue" />
          {{index.queue.length}} in queue
        </label>
      </h5>
      <ul class="queue" ng-show="showQueue">
        <li ng-repeat="request in index.queue">
          <h3>
            {{request.song.title}}
            <small>{{request.song.artist}} <span ng-show="song.duo">ðŸ‘¥</span></small>
          </h3>
          <small>{{request.singer}}</small>
        </li>
      </ul>

      <ul>
        <li ng-repeat="song in index.songs | filter:query | limitTo:1000" ng-click="index.request(song)">
          <h3>
            {{song.title}}
            <small>{{song.artist}} <span ng-show="song.duo">ðŸ‘¥</span></small>
          </h3>
          <small>{{song.year}}</small>
        </li>
      </ul>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.4/angular.min.js"></script>
    <script src="https://cdn.firebase.com/js/client/2.2.4/firebase.js"></script>
    <script src="https://cdn.firebase.com/libs/angularfire/1.1.2/angularfire.min.js"></script>
    <script>
      (function() {
        angular
          .module('karaoke', ['firebase'])
          .controller('index', Index);

        function Index($http, $firebaseArray) {
          var ref = new Firebase('https://blistering-inferno-5505.firebaseio.com/queue');
          this.queue = $firebaseArray(ref);

          var csv = 'e7ae9ce86b75e42f72cb27b0ca2b31c0.csv';
          $http.get(csv).success(function(data) {
            this.songs = data.split('\n').slice(1).map(function(line) {
              if (!line) return;
              var values = line.split(';'),
                  title = values[0].replace(/"/g, ''),
                  artist = values[1].replace(/"/g, '');

              return {
                title: title,
                artist: artist,
                year: values[2],
                duo: values[3] === '1',
              };
            });
          }.bind(this));
        }

        Index.prototype.request = function(song) {
          sessionStorage.name = sessionStorage.name || prompt('Who wants to sing?');
          if (confirm('Request ' + song.title + ' for ' + sessionStorage.name + '?')) {
            this.queue.$add({ song: song, singer: sessionStorage.name });
          } else {
            delete sessionStorage.name;
          }
        };
      })();
    </script>
  </body>
</html>
